
DROP TABLE IF EXISTS USER_INFO;

DROP TABLE IF EXISTS CORP_INFO;

CREATE TABLE CORP_INFO (
  CORP_ID INT(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '회사아이디',
  CORP_NM varchar(50) NOT NULL COMMENT '회사명',
  CORP_LOGO_PATH varchar(30) DEFAULT NULL COMMENT '로고파일위치',
  CORP_LOGO_NM varchar(50) DEFAULT NULL COMMENT '로고파일',
  CORP_LOGO_EXT varchar(5) DEFAULT NULL COMMENT '로고파일확장자',
  CORP_LOGO_SIZE bigint(20) DEFAULT NULL COMMENT '로고파일사이즈',
  CORP_LOGO_CONT_TYPE varchar(30) DEFAULT NULL COMMENT '로고파일컨텐츠타입',
  CORP_LOGO_ORG_FILE_NM varchar(50) DEFAULT NULL COMMENT '로고고유파일명',
  CORP_URL varchar(50) DEFAULT NULL COMMENT '홈페이지주소',
  CORP_TEL varchar(15) DEFAULT NULL COMMENT '전화번호',
  CORP_POST varchar(7) DEFAULT NULL COMMENT '우편번호',
  CORP_ADR varchar(150) DEFAULT NULL COMMENT '주소',
  CORP_ADR_DSC varchar(100) DEFAULT NULL COMMENT '상세주소',
  UP_CORP_ID INT(10) UNSIGNED DEFAULT '0' COMMENT '상위회사아이디',
  MOD_DT date NOT NULL COMMENT '수정일',
  MOD_ID varchar(20) NOT NULL COMMENT '수정자아이디',
  MOD_IP varchar(80) NOT NULL COMMENT '수정자아이피',
  REG_DT date NOT NULL COMMENT '등록일',
  REG_ID varchar(20) NOT NULL COMMENT '등록자아이디',
  REG_IP varchar(80) NOT NULL COMMENT '등록자아이피',
  PRIMARY KEY (CORP_ID)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='회사정보'
;

CREATE TABLE USER_INFO (
  USER_ID varchar(20) NOT NULL COMMENT '사용자아이디',
  CORP_ID INT(10) UNSIGNED DEFAULT '0' COMMENT '회사아이디',
  USER_NM varchar(50) NOT NULL COMMENT '이름',
  USER_PW varchar(50) NOT NULL COMMENT '패스워드',
  USER_EMAIL varchar(50) DEFAULT NULL COMMENT '이메일',
  USER_HP varchar(15) DEFAULT NULL COMMENT '휴대전화번호',
  USER_TEL varchar(15) DEFAULT NULL COMMENT '일반전화번호',
  USER_AUTH char(1) NOT NULL COMMENT '회원등급',
  USE_YN char(1) NOT NULL COMMENT '사용여부',
  ACCESS_FAIL_CNT tinyint(4) DEFAULT NULL COMMENT '로그인실패횟수',
  MOD_DT date NOT NULL COMMENT '수정일',
  MOD_ID varchar(20) NOT NULL COMMENT '수정자아이디',
  MOD_IP varchar(80) NOT NULL COMMENT '수정자아이피',
  REG_DT date NOT NULL COMMENT '등록일',
  REG_ID varchar(20) NOT NULL COMMENT '등록자아이디',
  REG_IP varchar(80) NOT NULL COMMENT '등록자아이피',
  PRIMARY KEY (USER_ID),
  KEY FK_CORP_INFO_TO_USER_INFO (CORP_ID),
  CONSTRAINT FK_CORP_INFO_TO_USER_INFO FOREIGN KEY (CORP_ID) REFERENCES CORP_INFO (CORP_ID)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='사용자'
;

INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 0, 'EVAN', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 1, '도로공사', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 2, '휴게소1', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 2, '휴게소2', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 2, '휴게소3', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 3, '휴게소업체1-1', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 3, '휴게소업체1-2', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 3, '휴게소업체1-3', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 4, '휴게소업체2-1', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 4, '휴게소업체2-2', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 4, '휴게소업체2-3', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 5, '휴게소업체3-1', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 5, '휴게소업체3-2', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 5, '휴게소업체3-3', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');

INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 1, '회사', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 15, '부서1', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 15, '부서2', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 15, '부서3', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 16, '부서파트1-1', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 16, '부서파트1-2', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 16, '부서파트1-3', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 17, '부서파트2-1', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 17, '부서파트2-2', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 17, '부서파트2-3', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 18, '부서파트3-1', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 18, '부서파트3-2', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');
INSERT INTO CORP_INFO(UP_CORP_ID, CORP_NM, MOD_DT, MOD_ID, MOD_IP, REG_DT, REG_ID, REG_IP) VALUES ( 18, '부서파트3-3', NOW(), 'SYSTEM', '127.0.0.1', NOW(), 'SYSTEM', '127.0.0.1');



INSERT INTO USER_INFO (USER_ID,CORP_ID,USER_NM,USER_PW,USER_EMAIL,USER_HP,USER_TEL,USER_AUTH,USE_YN,ACCESS_FAIL_CNT,MOD_DT,MOD_ID,MOD_IP,REG_DT,REG_ID,REG_IP) VALUES ('admin', 1, '관리자', 'nWsxfLXl5mvIuk880vK8Z/1Wk7B4DyRNiTNi8eUbCgg=', NULL, NULL, NULL, '0', 'Y', 0, SYSDATE(), 'system', '127.0.0.1', SYSDATE(), 'system', '127.0.0.1');

DROP FUNCTION IF EXISTS CORP_CONNECT_BY_PARENT;

DELIMITER $$

CREATE FUNCTION CORP_CONNECT_BY_PARENT() RETURNS INT
NOT DETERMINISTIC
READS SQL DATA
BEGIN
  DECLARE _ID INT;
  DECLARE _PARENT INT;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET @ID = NULL;

  SET _PARENT = @ID;
  SET _ID = -1;

  IF @ID IS NULL THEN
    RETURN NULL;
  END IF;

  LOOP
    SELECT MIN(CORP_ID)
      INTO @ID
      FROM CORP_INFO
     WHERE UP_CORP_ID = _PARENT
       AND CORP_ID > _ID;

    IF @ID IS NOT NULL OR _PARENT = @START_WITH THEN
      SET @LEVEL = @LEVEL + 1;
      RETURN @ID;
    END IF;

    SET @LEVEL := @LEVEL - 1;

    SELECT CORP_ID, UP_CORP_ID
      INTO _ID, _PARENT
      FROM CORP_INFO
     WHERE CORP_ID = _PARENT;
  END LOOP;
END

$$
DELIMITER ;


SELECT CONCAT(REPEAT(' ', LEVEL - 1), D.CORP_NM) AS CORP_NM
      ,D.CORP_ID
      ,D.UP_CORP_ID
      ,FUNC.LEVEL 
  FROM (
        SELECT CORP_CONNECT_BY_PARENT() AS CORP_ID
              ,@LEVEL AS LEVEL
          FROM (
                SELECT @START_WITH := 0
                      ,@ID := @START_WITH
                      ,@LEVEL := 0
               ) VARS
              ,CORP_INFO
         WHERE @ID IS NOT NULL
       ) FUNC
  JOIN CORP_INFO D
    ON FUNC.CORP_ID = D.CORP_ID;

SELECT *
  FROM USER_INFO;
